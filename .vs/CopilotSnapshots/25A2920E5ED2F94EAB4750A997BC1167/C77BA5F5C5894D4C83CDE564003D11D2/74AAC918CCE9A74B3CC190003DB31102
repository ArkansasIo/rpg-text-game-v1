using RPGMenuSystem.MenuSystem;

namespace RPGMenuSystem.UI;

public class CharacterCreationScreen
{
    private MenuManager _menuManager;
    private CharacterRace? _selectedRace;
    private CharacterClass? _selectedClass;
    private ClassSpecialization? _selectedSpec;
    private string _characterName = string.Empty;
    private Action<CharacterCreationResult> _onComplete;

    public CharacterCreationScreen(Action<CharacterCreationResult> onComplete)
    {
        _menuManager = new MenuManager();
        _onComplete = onComplete;
    }

    public void Show()
    {
        ShowWelcome();
        SelectName();
        SelectRace();
        SelectClass();
        SelectSpecialization();
        ShowSummary();
    }

    private void ShowWelcome()
    {
        Console.Clear();
        Console.ForegroundColor = ConsoleColor.Cyan;
        Console.WriteLine("\n\n");
        Console.WriteLine("    ╔════════════════════════════════════════════════════════════════╗");
        Console.WriteLine("    ║                                                                ║");
        Console.WriteLine("    ║              CHARACTER CREATION                                ║");
        Console.WriteLine("    ║                                                                ║");
        Console.WriteLine("    ║          Create your hero and begin your journey!              ║");
        Console.WriteLine("    ║                                                                ║");
        Console.WriteLine("    ╚════════════════════════════════════════════════════════════════╝");
        Console.ResetColor();
        Console.WriteLine("\n\n              Press any key to continue...");
        Console.ReadKey(true);
    }

    private void SelectName()
    {
        Console.Clear();
        Console.ForegroundColor = ConsoleColor.Yellow;
        Console.WriteLine("\n\n    === CHARACTER NAME ===\n");
        Console.ResetColor();
        Console.Write("    Enter your character name: ");
        _characterName = Console.ReadLine() ?? "Hero";
        
        if (string.IsNullOrWhiteSpace(_characterName))
        {
            _characterName = "Hero";
        }
    }

    private void SelectRace()
    {
        var races = RaceInfo.GetAllRaces();
        var raceMenu = new Menu
        {
            Title = "Select Your Race",
            Items = new List<MenuItem>()
        };

        foreach (var race in races)
        {
            var capturedRace = race;
            raceMenu.Items.Add(new MenuItem
            {
                Text = $"{race.Name} - {race.Description}",
                OnSelect = () => { _selectedRace = capturedRace.Race; _menuManager.CloseCurrentMenu(); }
            });
        }

        _menuManager.OpenMenu(raceMenu);

        while (_menuManager.CurrentMenu != null)
        {
            RenderRaceScreen(races);
            var key = Console.ReadKey(true).Key;
            _menuManager.HandleInput(key);
        }
    }

    private void RenderRaceScreen(List<RaceInfo> races)
    {
        Console.Clear();
        Console.ForegroundColor = ConsoleColor.Cyan;
        Console.WriteLine("\n    ╔════════════════════════════════════════════════════════════════╗");
        Console.WriteLine("    ║                    SELECT YOUR RACE                            ║");
        Console.WriteLine("    ╚════════════════════════════════════════════════════════════════╝");
        Console.ResetColor();

        if (_menuManager.CurrentMenu != null)
        {
            Console.WriteLine();
            for (int i = 0; i < _menuManager.CurrentMenu.Items.Count; i++)
            {
                var item = _menuManager.CurrentMenu.Items[i];
                var prefix = i == _menuManager.CurrentMenu.SelectedIndex ? "    >>> " : "        ";
                
                Console.ForegroundColor = i == _menuManager.CurrentMenu.SelectedIndex ? ConsoleColor.Yellow : ConsoleColor.White;
                Console.WriteLine($"{prefix}{item.Text}");
                Console.ResetColor();
            }

            // Show detailed info for selected race
            var selectedRace = races[_menuManager.CurrentMenu.SelectedIndex];
            Console.WriteLine("\n    ────────────────────────────────────────────────────────────────");
            Console.ForegroundColor = ConsoleColor.Green;
            Console.WriteLine($"\n    Racial Bonuses:");
            foreach (var bonus in selectedRace.RacialBonuses)
            {
                Console.WriteLine($"      +{bonus.Value} {bonus.Key}");
            }
            Console.WriteLine($"\n    Racial Abilities:");
            foreach (var ability in selectedRace.RacialAbilities)
            {
                Console.WriteLine($"      • {ability}");
            }
            Console.WriteLine($"\n    Available Classes:");
            foreach (var classType in selectedRace.AvailableClasses)
            {
                Console.WriteLine($"      • {classType}");
            }
            Console.ResetColor();
        }

        Console.WriteLine("\n    [Arrow Keys: Navigate | Enter: Select]");
    }

    private void SelectClass()
    {
        var classes = ClassInfo.GetAllClasses();
        var selectedRaceInfo = RaceInfo.GetAllRaces().FirstOrDefault(r => r.Race == _selectedRace);
        
        // Filter classes available to selected race
        var availableClasses = classes.Where(c => selectedRaceInfo?.AvailableClasses.Contains(c.Class) ?? false).ToList();

        var classMenu = new Menu
        {
            Title = "Select Your Class",
            Items = new List<MenuItem>()
        };

        foreach (var classInfo in availableClasses)
        {
            var capturedClass = classInfo;
            classMenu.Items.Add(new MenuItem
            {
                Text = $"{classInfo.Name} - {classInfo.Role}",
                OnSelect = () => { _selectedClass = capturedClass.Class; _menuManager.CloseCurrentMenu(); }
            });
        }

        _menuManager.OpenMenu(classMenu);

        while (_menuManager.CurrentMenu != null)
        {
            RenderClassScreen(availableClasses);
            var key = Console.ReadKey(true).Key;
            _menuManager.HandleInput(key);
        }
    }

    private void RenderClassScreen(List<ClassInfo> classes)
    {
        Console.Clear();
        Console.ForegroundColor = ConsoleColor.Cyan;
        Console.WriteLine("\n    ╔════════════════════════════════════════════════════════════════╗");
        Console.WriteLine("    ║                    SELECT YOUR CLASS                           ║");
        Console.WriteLine("    ╚════════════════════════════════════════════════════════════════╝");
        Console.ResetColor();

        if (_menuManager.CurrentMenu != null)
        {
            Console.WriteLine();
            for (int i = 0; i < _menuManager.CurrentMenu.Items.Count; i++)
            {
                var item = _menuManager.CurrentMenu.Items[i];
                var prefix = i == _menuManager.CurrentMenu.SelectedIndex ? "    >>> " : "        ";
                
                Console.ForegroundColor = i == _menuManager.CurrentMenu.SelectedIndex ? ConsoleColor.Yellow : ConsoleColor.White;
                Console.WriteLine($"{prefix}{item.Text}");
                Console.ResetColor();
            }

            // Show detailed info for selected class
            var selectedClass = classes[_menuManager.CurrentMenu.SelectedIndex];
            Console.WriteLine("\n    ────────────────────────────────────────────────────────────────");
            Console.ForegroundColor = ConsoleColor.Green;
            Console.WriteLine($"\n    Description: {selectedClass.Description}");
            Console.WriteLine($"    Role: {selectedClass.Role}");
            Console.WriteLine($"    Primary Resource: {selectedClass.PrimaryResource}");
            Console.WriteLine($"\n    Starting Stats:");
            foreach (var stat in selectedClass.StartingStats)
            {
                Console.WriteLine($"      {stat.Key}: {stat.Value}");
            }
            Console.WriteLine($"\n    Specializations:");
            foreach (var spec in selectedClass.Specializations)
            {
                Console.WriteLine($"      • {spec}");
            }
            Console.ResetColor();
        }

        Console.WriteLine("\n    [Arrow Keys: Navigate | Enter: Select]");
    }

    private void SelectSpecialization()
    {
        var selectedClassInfo = ClassInfo.GetAllClasses().FirstOrDefault(c => c.Class == _selectedClass);
        if (selectedClassInfo == null) return;

        var specMenu = new Menu
        {
            Title = "Select Your Specialization",
            Items = new List<MenuItem>()
        };

        foreach (var spec in selectedClassInfo.Specializations)
        {
            var capturedSpec = spec;
            specMenu.Items.Add(new MenuItem
            {
                Text = spec.ToString(),
                OnSelect = () => { _selectedSpec = capturedSpec; _menuManager.CloseCurrentMenu(); }
            });
        }

        _menuManager.OpenMenu(specMenu);

        while (_menuManager.CurrentMenu != null)
        {
            RenderSpecScreen();
            var key = Console.ReadKey(true).Key;
            _menuManager.HandleInput(key);
        }
    }

    private void RenderSpecScreen()
    {
        Console.Clear();
        Console.ForegroundColor = ConsoleColor.Cyan;
        Console.WriteLine("\n    ╔════════════════════════════════════════════════════════════════╗");
        Console.WriteLine("    ║              SELECT YOUR SPECIALIZATION                        ║");
        Console.WriteLine("    ╚════════════════════════════════════════════════════════════════╝");
        Console.ResetColor();

        if (_menuManager.CurrentMenu != null)
        {
            Console.WriteLine();
            for (int i = 0; i < _menuManager.CurrentMenu.Items.Count; i++)
            {
                var item = _menuManager.CurrentMenu.Items[i];
                var prefix = i == _menuManager.CurrentMenu.SelectedIndex ? "    >>> " : "        ";
                
                Console.ForegroundColor = i == _menuManager.CurrentMenu.SelectedIndex ? ConsoleColor.Yellow : ConsoleColor.White;
                Console.WriteLine($"{prefix}{item.Text}");
                Console.ResetColor();
            }
        }

        Console.WriteLine("\n    [Arrow Keys: Navigate | Enter: Select]");
    }

    private void ShowSummary()
    {
        Console.Clear();
        Console.ForegroundColor = ConsoleColor.Cyan;
        Console.WriteLine("\n    ╔════════════════════════════════════════════════════════════════╗");
        Console.WriteLine("    ║                 CHARACTER SUMMARY                              ║");
        Console.WriteLine("    ╚════════════════════════════════════════════════════════════════╝");
        Console.ResetColor();

        Console.ForegroundColor = ConsoleColor.Yellow;
        Console.WriteLine($"\n    Name: {_characterName}");
        Console.WriteLine($"    Race: {_selectedRace}");
        Console.WriteLine($"    Class: {_selectedClass}");
        Console.WriteLine($"    Specialization: {_selectedSpec}");
        Console.ResetColor();

        Console.WriteLine("\n\n    Is this correct? (Y/N)");
        var key = Console.ReadKey(true).Key;

        if (key == ConsoleKey.Y)
        {
            _onComplete(new CharacterCreationResult
            {
                Name = _characterName,
                Race = _selectedRace ?? CharacterRace.Human,
                Class = _selectedClass ?? CharacterClass.Warrior,
                Specialization = _selectedSpec ?? ClassSpecialization.WarriorArms
            });
        }
        else
        {
            Show(); // Restart creation
        }
    }
}

public class CharacterCreationResult
{
    public string Name { get; set; } = string.Empty;
    public CharacterRace Race { get; set; }
    public CharacterClass Class { get; set; }
    public ClassSpecialization Specialization { get; set; }
}
